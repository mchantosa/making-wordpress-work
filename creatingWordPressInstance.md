# Creating a WorPress Beta Environment

Note: Be careful using SSH through VSCode to connect to your EC2 Instance. I do this sometimes when an instance server isn't serving. There is limited memory available at the freemium tier. When you start your server, using VSCode to remote in simultaneously can push your  sinstance to it's limits. I close out my VSCode before initializing a server.
## Create an EC2 instance (using Ubuntu)
1. Create an EC2 instance (I am using an Ubuntu template)
    *   Make sure that you save off your PEM
    *   Configure a security group with HTTP to port 80, HTTPS to port 443, and SSH to port 22.
    *   Max out freemium tier
1. Prep instance
    ```sh
         # Update the Package Repository Cache
        sudo apt update

        # Upgrade Installed Packages
        sudo apt upgrade

        # Remove Unnecessary Packages
        sudo apt autoremove

        # Reboot the System
        sudo reboot
    ```
1.  Set up elastic ip to this instance

    In this case, it is necessary to use elastic IP. If you don't, when you spin down your instance and restart it, the wordpress won't work because the instance name will have changed and it will differ from the WordPress configuration files. It might be possible to configure your Route 53 domain to the EC2 instance and then do the installer, and reconfigure Route 53 every time you spin down your instance... But I don't feel like doing that, so I'm just going to elastic IP this. 
    *   Create an elastic IP, attach your EC2 instance to it.
    *   Update your Route 53 or DNS manager with this fixed public DNS.

1.  Install Docker [instructions](https://docs.docker.com/engine/install/)
    *   Set up Docker's apt repository
        ```sh
            # Add Docker's official GPG key:
            sudo apt-get update
            sudo apt-get install ca-certificates curl
            sudo install -m 0755 -d /etc/apt/keyrings
            sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
            sudo chmod a+r /etc/apt/keyrings/docker.asc

            # Add the repository to Apt sources:
            echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
        ```
    *   Install the Docker packages
        ```sh
            #Install
            sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            #start the service
            sudo service docker start

            #create the docker group
            sudo groupadd docker

            #add ubuntu as user
            sudo usermod -aG docker ubuntu

            #refresh session
            newgrp docker

            #change owners
            sudo chown "$USER":"$USER" /home/"$USER"/.docker -R

            #change permissions
            sudo chmod g+rwx "$HOME/.docker" -R
            
            #verify install
            docker run hello-world
        ```
    *   [Install lazydocker](https://github.com/jesseduffield/lazydocker?tab=readme-ov-file#binary-release-linuxosxwindows), this gives you a CLI/GUI interface instead of going straight command line
        ```sh
            #install docker
            curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash

            #add $HOME/.local/bin to path
            export PATH=$PATH:$HOME/.local/bin

            #start lazydocker
            lazydocker
        ```
## Create an empty WordPress instance
1. Configure for WordPress install
    *   Create a `workspace` directory
        ```sh
            mkdir workspace
        ```
    *   Create archive and installer files

        I am using an archive.zip and installer.php generated by a duplicator plugin. For this, follow the duplicator instructions, save off the archive and installer, and then delete the archive, as it is stored in a public library. 

    *   Copy over installation files into `workspace` directory
        
        You can drop the installer into your VSCode window if you have VSCode configured to your EC2 instance PEM, the installer is small. The zip file is huge, you will need to do a secure file transfer though an scp protocol. 
        
        ```sh
            #format of scp call
            scp -i /path/to/your/private-key.pem /path/to/your/archive ubuntu@your-ec2-public-dns:/home/ubuntu/workspace

            #for me, the calls looks like this
            scp -i \
            ~/Workspace/ec2Instance.pem \
            ~/Downloads/archiveName.zip \
            ubuntu@your-ec2-public-dns:/home/ubuntu/workspace

            scp -i \
            ~/Workspace/ec2Instance.pem \
            ~/Downloads/installer.php \
            ubuntu@your-ec2-public-dns:/home/ubuntu/workspace
        ```
1.  Create a docker-compose.yml for your WordPress site in your `workspace` directory

    This will be your schematic for your WordPress environment. In this yaml, you will define your database, myPHP, and WordPress containers as well as their internal network configuration. This is where I would open VSCode and establish a connection to your instance using your PEM, then close the VSCode instance before you docker compose.

    ```yml
        version: "3"

        services:
            # Database
            db:
                image: mariadb:10.6.4-focal
                command: "--default-authentication-plugin=mysql_native_password"
                volumes:
                - db_data:/var/lib/mysql
                restart: always
                environment:
                    MYSQL_ROOT_PASSWORD: password
                    MYSQL_DATABASE: wordpress
                    MYSQL_USER: wordpress
                    MYSQL_PASSWORD: wordpress
                expose:
                - 3306
                - 33060
                networks:
                - wpsite
            # phpmyadmin
            phpmyadmin:
                depends_on:
                - db
                image: phpmyadmin:latest
                restart: always
                ports:
                - "8008:80"
                environment:
                    PMA_HOST: db
                    MYSQL_ROOT_PASSWORD: password
                networks:
                - wpsite
            # Wordpress
            wordpress:
                depends_on:
                - db
                image: wordpress:latest
                ports:
                - "80:80"
                restart: always
                volumes: ["./wordpress:/var/www/html"]
                environment:
                    WORDPRESS_DB_HOST: db:3306
                    WORDPRESS_DB_USER: wordpress
                    WORDPRESS_DB_PASSWORD: wordpress
                    WORDPRESS_DB_NAME: wordpress
                networks:
                - wpsite
        networks:
            wpsite:
        volumes:
            db_data:
    ```
1.  Create an empty WordPress site.
    *   Execute this command from your `workspace` directory
        ```sh
            #from /workspace
            docker compose up -d
        ```
    *   Go to your EC2 instance DNS or an associated mapped domain, this should lead to a new instance of WordPress. Walk through WordPress installation wizard. You can use loose user parameters, we are going to blow this site away pretty immediately and replace all users with your archive. 
    *   Login
## Import WordPress instance
1.  Copy the archive and installer from your `workspace` to your `wordpress` directory.

    As a result of your `docker compose up`, you should now have a `wordpress` directory within your `workspace` directory.  You want to copy these files, not move them. In the event this install fails, you want the files to remain available.

    ```sh
        #from workspace
        sudo cp archive.zip ./wordpress
        sudo cp installer.php ./wordpress
    ```
1. Navigate to you http://your-ec2-instance/installer.php, use these options
    *   Action: Empty Database
    *   Host: db
    *   Database: wordpress
    *   User: wordpress
    *   Password: wordpress
1.  Validate... accept terms... Next
1.  Login as administrator using credentials for your archived site
1.  Boom! You should now be logged into a copy of your WordPress site